<!DOCTYPE html>
<html>
  <head>
    <!--
      ========================================================================
      SuperSlides - Sidebar.html
      ========================================================================
      
      This is the sidebar UI that appears when users click SuperSlides > Open Sidebar.
      
      Key concepts:
      - This HTML runs in an IFRAME inside Google Slides (client-side/browser)
      - It CANNOT directly access Google Slides data or APIs
      - To do anything useful, it must call server-side functions in Code.gs
      - Communication happens via google.script.run (a special Apps Script bridge)
      
      Architecture:
      
        [Sidebar HTML/JS]  ←—google.script.run—→  [Code.gs on Google servers]
              ↓                                           ↓
        User sees UI                              Accesses Slides API
        Handles clicks                            Reads/moves shapes
        Shows status                              Stores properties
      
      ========================================================================
    -->
    
    <!--
      base target="_top" is a Google Apps Script best practice.
      
      The sidebar runs in an iframe. Without this, if you add any links (<a href>),
      they would try to open inside the tiny iframe instead of in a new tab.
      target="_top" makes links open in the main browser window.
    -->
    <base target="_top">

    <style>
      /*
        ======================================================================
        STYLES
        ======================================================================
        
        Minimal styling for MVP.
        Later we'll replace this with a proper design system including:
        - Custom colors and spacing variables
        - SVG icons for buttons
        - Hover/active states
        - Grouped button layouts
      */
      
      /* Base body styles */
      body {
        font-family: Arial, sans-serif;  /* Clean, readable font */
        padding: 12px;                   /* Space around content */
      }

      /* Remove default top margin from heading */
      h3 {
        margin-top: 0;
      }

      /* Button styles - all buttons are full-width blocks */
      button {
        display: block;      /* Stack buttons vertically */
        width: 100%;         /* Full width of sidebar */
        margin: 8px 0;       /* Vertical spacing between buttons */
        padding: 8px;        /* Inner padding for click target */
        font-size: 14px;     /* Readable text size */
        cursor: pointer;     /* Show hand cursor on hover */
      }

      /* Status text area at the bottom */
      #status {
        margin-top: 12px;    /* Space above status */
        font-size: 12px;     /* Smaller text for status */
        color: #555;         /* Gray color - less prominent than buttons */
      }
    </style>
  </head>

  <body>
    <!--
      ======================================================================
      HTML STRUCTURE
      ======================================================================
      
      The sidebar is organized into sections:
      1. Title
      2. Anchor controls (Set/Clear)
      3. Alignment controls (Align Left, Align Right, etc.)
      4. Status display
      
      Each button has an onclick handler that calls a JavaScript function
      defined in the <script> section below.
    -->
    
    <!-- Sidebar title - matches the menu name -->
    <h3>SuperSlides</h3>

    <!-- 
      ANCHOR CONTROLS
      
      Set Anchor: Saves the currently selected shape as the reference point
      Clear Anchor: Removes the saved anchor, reverts to fallback behavior
    -->
    <button onclick="runSetAnchor()">Set Anchor</button>
    <button onclick="runClearAnchor()">Clear Anchor</button>

    <!-- Visual separator between anchor and alignment controls -->
    <hr>

    <!-- 
      ALIGNMENT CONTROLS
      
      These buttons align selected shapes relative to the anchor.
      User should select 2+ shapes before clicking.
      
      Horizontal alignment (shapes move left/right):
      - Align Left: left edges line up
      - Align Right: right edges line up
      - Align Center: horizontal centers line up
      
      Vertical alignment (shapes move up/down):
      - Align Top: top edges line up
      - Align Bottom: bottom edges line up
      - Align Middle: vertical centers line up
    -->
    <button onclick="runAlignLeft()">Align Left</button>
    <button onclick="runAlignRight()">Align Right</button>
    <button onclick="runAlignCenter()">Align Center</button>
    <button onclick="runAlignTop()">Align Top</button>
    <button onclick="runAlignBottom()">Align Bottom</button>
    <button onclick="runAlignMiddle()">Align Middle</button>

    <hr>

    <!-- 
      TABLE ALIGNMENT CONTROLS
      
      These buttons align shapes within their containing table cells.
      User should:
      1. Have a table on the slide
      2. Select shapes that are inside table cells
      3. Specify padding (distance from cell edge)
      4. Click alignment button
      
      Shapes are aligned within their cells, not relative to each other.
      Multiple shapes in the same cell are stacked vertically.
    -->
    <h4 style="margin-top: 16px; margin-bottom: 8px;">Table Alignment</h4>
    <button onclick="showTableAlignDialog()">Align in Table</button>
    
    <!-- Modal Dialog for Table Alignment -->
    <div id="tableAlignModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 250px;">
        <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 16px;">Align in Table</h3>
        
        <div style="margin-bottom: 16px;">
          <label style="font-size: 13px; font-weight: bold; display: block; margin-bottom: 8px;">Alignment:</label>
          <label style="display: block; margin-bottom: 6px; font-size: 13px;">
            <input type="radio" name="tableAlign" value="left" checked style="margin-right: 6px;">
            Left
          </label>
          <label style="display: block; margin-bottom: 6px; font-size: 13px;">
            <input type="radio" name="tableAlign" value="center" style="margin-right: 6px;">
            Center
          </label>
          <label style="display: block; margin-bottom: 6px; font-size: 13px;">
            <input type="radio" name="tableAlign" value="right" style="margin-right: 6px;">
            Right
          </label>
        </div>
        
        <div style="margin-bottom: 16px;">
          <label for="modalTablePadding" style="font-size: 13px; font-weight: bold; display: block; margin-bottom: 4px;">Padding (points):</label>
          <input type="number" id="modalTablePadding" value="10" min="0" style="width: 100%; padding: 6px; box-sizing: border-box; font-size: 13px;">
        </div>
        
        <div style="display: flex; gap: 8px; justify-content: flex-end;">
          <button onclick="hideTableAlignDialog()" style="background: #ddd; color: #333;">Cancel</button>
          <button onclick="runTableAlign()" style="background: #4285f4; color: white;">Apply</button>
        </div>
      </div>
    </div>

    <hr>

    <!-- 
      MATRIX ALIGNMENT CONTROLS
      
      Arranges selected shapes into a grid/matrix layout.
      User should:
      1. Select shapes to arrange
      2. Specify desired rows and columns
      3. Specify spacing between shapes
      4. Click "Arrange in Matrix"
      
      Features:
      - Auto-expands dimensions if shapes don't fit (e.g., 10 shapes in 3x3 → 4x3)
      - Maintains selection order (shapes not sorted by position)
      - Uses selection bounds as reference area
    -->
    <h4 style="margin-top: 16px; margin-bottom: 8px;">Matrix Alignment</h4>
    <label for="matrixRows" style="font-size: 12px; color: #666;">Rows:</label>
    <input type="number" id="matrixRows" value="3" min="1" style="width: 100%; padding: 4px; margin-bottom: 8px; box-sizing: border-box;">
    <label for="matrixCols" style="font-size: 12px; color: #666;">Columns:</label>
    <input type="number" id="matrixCols" value="3" min="1" style="width: 100%; padding: 4px; margin-bottom: 8px; box-sizing: border-box;">
    <label for="matrixSpacing" style="font-size: 12px; color: #666;">Spacing (points):</label>
    <input type="number" id="matrixSpacing" value="20" min="0" style="width: 100%; padding: 4px; margin-bottom: 8px; box-sizing: border-box;">
    <button onclick="runArrangeMatrix()">Arrange in Matrix</button>

    <hr>

    <!-- 
      STATUS DISPLAY
      
      Shows feedback to the user:
      - Current anchor state (on load)
      - "Aligning..." during operations
      - Success/error messages after operations
    -->
    <div id="status">Loading…</div>

    <!--
      ======================================================================
      CLIENT-SIDE JAVASCRIPT
      ======================================================================
      
      This JavaScript runs in the browser (inside the sidebar iframe).
      It handles:
      - Button click events
      - Calling server-side functions via google.script.run
      - Updating the UI with results
      
      IMPORTANT: google.script.run is ASYNCHRONOUS
      - The call returns immediately (doesn't wait for server)
      - You provide callbacks to handle success/failure
      - withSuccessHandler() - called when server function succeeds
      - withFailureHandler() - called when server function throws an error
    -->
    <script>
      /**
       * refreshStatus()
       *
       * Fetches the current anchor status from the server and displays it.
       * Called when the sidebar first loads, and after anchor operations.
       * 
       * How google.script.run works:
       * 1. google.script.run creates a connection to the server
       * 2. .withSuccessHandler(callback) registers a function to call on success
       * 3. .getAnchorStatus() is the server function name (defined in Code.gs)
       * 4. When server responds, callback receives the return value as argument
       */
      function refreshStatus() {
        google.script.run
          .withSuccessHandler(function (text) {
            // 'text' is whatever getAnchorStatus() returned
            // Update the status div with this text
            document.getElementById('status').innerText = text;
          })
          .getAnchorStatus();  // Call the server-side function
      }

      /**
       * runSetAnchor()
       *
       * Called when user clicks "Set Anchor" button.
       * 
       * Flow:
       * 1. Calls server-side setAnchor() function
       * 2. setAnchor() stores the selected element's ID
       * 3. On success, refreshStatus() is called to update the display
       * 
       * Note: We pass refreshStatus as the success handler (not refreshStatus())
       * This means "call this function when done", not "call it now"
       */
      function runSetAnchor() {
        google.script.run
          .withSuccessHandler(refreshStatus)  // After success, refresh the status
          .setAnchor();                       // Call server function
      }

      /**
       * runClearAnchor()
       *
       * Called when user clicks "Clear Anchor" button.
       * Similar to runSetAnchor - clears the anchor then refreshes status.
       */
      function runClearAnchor() {
        google.script.run
          .withSuccessHandler(refreshStatus)
          .clearAnchor();
      }

      /**
       * runAlignLeft()
       *
       * Called when user clicks "Align Left" button.
       * 
       * This has more complex handling than anchor functions because:
       * 1. We want immediate feedback ("Aligning left...")
       * 2. We want to show the result message from the server
       * 3. We want to catch and display any errors
       * 
       * Flow:
       * 1. Immediately show "Aligning left..." (user knows click worked)
       * 2. Call server-side alignLeft()
       * 3. On success: show the return message (e.g., "Aligned 3 element(s)...")
       * 4. On failure: show the error with ❌ prefix
       */
      function runAlignLeft() {
        // Immediate feedback - show user that button click was registered
        document.getElementById('status').innerText = 'Aligning left…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            // 'msg' is the string returned by alignLeft()
            // If msg is empty/null for some reason, show generic "Aligned."
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            // 'err' is an Error object if the server function threw an exception
            // Display the error message to help with debugging
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignLeft();  // Call server function
      }

      /**
       * runAlignRight()
       *
       * Called when user clicks "Align Right" button.
       * Same pattern as runAlignLeft - immediate feedback, success/error handling.
       */
      function runAlignRight() {
        // Immediate feedback
        document.getElementById('status').innerText = 'Aligning right…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignRight();
      }

      /**
       * runAlignTop()
       *
       * Called when user clicks "Align Top" button.
       * 
       * This aligns the TOP edges of all selected shapes to the anchor's top edge.
       * Shapes move vertically (up/down) while keeping their horizontal position.
       * 
       * Same pattern as other alignment functions:
       * 1. Show immediate feedback ("Aligning top...")
       * 2. Call server-side alignTop()
       * 3. Display result or error
       */
      function runAlignTop() {
        // Immediate feedback - show user that button click was registered
        document.getElementById('status').innerText = 'Aligning top…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            // 'msg' is the string returned by alignTop()
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            // Display the error message to help with debugging
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignTop();  // Call server function
      }

      /**
       * runAlignBottom()
       *
       * Called when user clicks "Align Bottom" button.
       * 
       * This aligns the BOTTOM edges of all selected shapes to the anchor's bottom edge.
       * Shapes move vertically (up/down) while keeping their horizontal position.
       * 
       * Note: Like alignRight, this requires calculating where each shape's TOP
       * needs to be so that its BOTTOM aligns with the anchor's bottom.
       */
      function runAlignBottom() {
        // Immediate feedback
        document.getElementById('status').innerText = 'Aligning bottom…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignBottom();
      }

      /**
       * runAlignCenter()
       *
       * Called when user clicks "Align Center" button.
       * 
       * This aligns the HORIZONTAL CENTERS of all selected shapes to the anchor's center.
       * Shapes move horizontally (left/right) while keeping their vertical position.
       * 
       * Note: This is center-based alignment, not edge-based. Each shape's center
       * point aligns with the anchor's center, regardless of shape width.
       */
      function runAlignCenter() {
        // Immediate feedback
        document.getElementById('status').innerText = 'Aligning center…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignCenter();
      }

      /**
       * runAlignMiddle()
       *
       * Called when user clicks "Align Middle" button.
       * 
       * This aligns the VERTICAL CENTERS of all selected shapes to the anchor's center.
       * Shapes move vertically (up/down) while keeping their horizontal position.
       * 
       * Note: This is center-based alignment, not edge-based. Each shape's center
       * point aligns with the anchor's center, regardless of shape height.
       */
      function runAlignMiddle() {
        // Immediate feedback
        document.getElementById('status').innerText = 'Aligning middle…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignMiddle();
      }

      /**
       * showTableAlignDialog()
       *
       * Shows the modal dialog for table alignment options.
       */
      function showTableAlignDialog() {
        document.getElementById('tableAlignModal').style.display = 'block';
      }

      /**
       * hideTableAlignDialog()
       *
       * Hides the modal dialog for table alignment options.
       */
      function hideTableAlignDialog() {
        document.getElementById('tableAlignModal').style.display = 'none';
      }

      /**
       * runTableAlign()
       *
       * Executes table alignment with user-selected options from the dialog.
       * 
       * Reads the selected alignment (left/center/right) and padding value,
       * then calls the server-side alignToTable function.
       */
      function runTableAlign() {
        // Get selected alignment
        const alignmentRadios = document.getElementsByName('tableAlign');
        let alignment = 'left'; // default
        for (let radio of alignmentRadios) {
          if (radio.checked) {
            alignment = radio.value;
            break;
          }
        }
        
        // Get padding value
        const padding = parseFloat(document.getElementById('modalTablePadding').value) || 10;
        
        // Hide the dialog
        hideTableAlignDialog();
        
        // Show status
        document.getElementById('status').innerText = 'Aligning to table (' + alignment + ')…';
        
        // Call server function
        google.script.run
          .withSuccessHandler(function (msg) {
            document.getElementById('status').innerText = msg || 'Aligned.';
          })
          .withFailureHandler(function (err) {
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .alignToTable(alignment, padding);
      }

      /**
       * runArrangeMatrix()
       *
       * Called when user clicks "Arrange in Matrix" button.
       * 
       * Arranges selected shapes into a grid/matrix layout with user-specified
       * dimensions and spacing.
       * 
       * Features:
       * - Auto-expands dimensions if shapes don't fit requested size
       * - Maintains selection order (shapes not sorted)
       * - Uses selection bounds as reference area
       */
      function runArrangeMatrix() {
        const rows = parseInt(document.getElementById('matrixRows').value) || 3;
        const cols = parseInt(document.getElementById('matrixCols').value) || 3;
        const spacing = parseFloat(document.getElementById('matrixSpacing').value) || 20;
        
        // Validate inputs
        if (rows <= 0 || cols <= 0) {
          document.getElementById('status').innerText = '❌ Error: Rows and columns must be positive numbers.';
          return;
        }
        
        if (spacing < 0) {
          document.getElementById('status').innerText = '❌ Error: Spacing cannot be negative.';
          return;
        }
        
        document.getElementById('status').innerText = 'Arranging in matrix…';
        
        google.script.run
          .withSuccessHandler(function (msg) {
            document.getElementById('status').innerText = msg || 'Arranged.';
          })
          .withFailureHandler(function (err) {
            document.getElementById('status').innerText =
              '❌ Error: ' + (err && err.message ? err.message : JSON.stringify(err));
          })
          .arrangeMatrix(rows, cols, spacing);
      }

      // ====================================================================
      // INITIALIZATION
      // ====================================================================
      
      // When the sidebar HTML loads, immediately fetch and display
      // the current anchor status so user knows the state
      refreshStatus();
    </script>
  </body>
</html>
